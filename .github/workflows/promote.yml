name: Promote
on:
    repository_dispatch:
        types: [promote-command]
env:
    NAMESPACE: teamforeldrepenger
    IMAGE_BASE: ghcr.io/${{ github.repository }}

jobs:
    promote:
        runs-on: ubuntu-latest
        steps:
            # Trenger vi denne?
            #      - name: Sjekk ut kode
            #        uses: actions/checkout@v2
            #        with:
            #          ref: ${{ github.event.inputs.tag }}

            - name: Sett variabler for cluster og tag
              run: |
                  echo "TAG=$(echo ${{ github.event.client_payload.github.payload.issue.title }} | awk '{print $NF}' | awk -F- '{print $NF}')" >> $GITHUB_ENV
                  echo "IMAGE=$IMAGE_BASE:$(echo ${{ github.event.client_payload.github.payload.issue.title }} | awk '{print $NF}')" >> $GITHUB_ENV
                  echo "CLUSTER=${{github.event.client_payload.slash_command.args.unnamed.arg1}}" >> $GITHUB_ENV

            - name: Promoter til cluster og namespace
              uses: nais/deploy/actions/deploy@v1
              env:
                  PRINT_PAYLOAD: true
                  APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
                  CLUSTER: ${{ github.event.inputs.cluster }}
                  RESOURCE: .deploy/naiserator.yaml
                  VARS: .deploy/${{ github.event.inputs.cluster }}-${{ env.NAMESPACE }}.json

            - name: Oppdater kommentar med deployment status ved feil
              if: failure()
              uses: actions/github-script@v5
              with:
                  github-token: ${{secrets.GITHUB_TOKEN}}
                  script: |
                      const issue = { owner: context.issue.owner,
                                      repo: context.issue.repo,
                                      issue_number: ${{ github.event.client_payload.github.payload.issue.number }} }
                      github.rest.issues.createComment({...issue,
                                      title: 'Deploy av ${{ env.TAG }}',
                                      body: 'promote til ${{ env.CLUSTER }} ${{ env.NAMESPACE }} feilet'})
                      github.rest.issues.addLabels({...issue, labels: ['deployment-failed','${{ env.CLUSTER }}-${{ env.NAMESPACE }}']})

            - name: Oppdater kommentar med deployment status
              if: success()
              uses: actions/github-script@v5
              with:
                  github-token: ${{secrets.GITHUB_TOKEN}}
                  script: |
                      const issue = { owner: context.issue.owner,
                                      repo: context.issue.repo,
                                      issue_number: ${{ github.event.inputs.issue_number }} }
                      github.rest.issues.createComment({...issue,
                                      body: 'promote til ${{ env.CLUSTER }} ${{ env.NAMESPACE }} utf√∏rt'})
                      github.rest.issues.addLabels({...issue, labels: ['deployment','${{ env.CLUSTER }}-${{ env.NAMESPACE }}']})
