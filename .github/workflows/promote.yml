name: Promote
on:
    workflow_dispatch:
        inputs:
            tag:
                description: 'Github tag (sha)'
                required: true
            image_version:
                description: 'Versjon av docker image som skal deployes'
                required: true
            issue_number:
                description: 'Issue number på issue som det ble kommentert i'
                required: true
            cluster:
                description: 'Cluster som vi skal deploy image til (dev-fss eller prod-fss)'
                required: true
                default: 'dev-fss'
env:
    NAMESPACE: teamforeldrepenger
    IMAGE: ghcr.io/${{ github.repository }}:${{ github.event.inputs.image_version }} # Brukes av .deploy fil

jobs:
    promote:
        if: contains(github.event.comment.html_url, '/issues/') && startsWith( github.event.comment.body, '/promote ' )
        runs-on: ubuntu-latest
        steps:
            # Trenger vi denne?
            #      - name: Sjekk ut kode
            #        uses: actions/checkout@v2
            #        with:
            #          ref: ${{ github.event.inputs.tag }}

            - name: Promoter til cluster og namespace
              uses: nais/deploy/actions/deploy@v1
              env:
                  PRINT_PAYLOAD: true
                  APIKEY: ${{ secrets.NAIS_DEPLOY_APIKEY }}
                  CLUSTER: ${{ github.event.inputs.cluster }}
                  RESOURCE: .deploy/naiserator.yaml
                  VARS: .deploy/${{ github.event.inputs.cluster }}-${{ env.NAMESPACE }}.json

            - name: Oppdater kommentar med deployment status ved feil
              if: failure()
              uses: actions/github-script@v5
              with:
                  github-token: ${{secrets.GITHUB_TOKEN}}
                  script: |
                      const issue = { owner: context.issue.owner,
                                      repo: context.issue.repo,
                                      issue_number: ${{ github.event.inputs.issue_number }} }
                      github.rest.issues.createComment({...issue,
                                              title: 'Deploy av ${{ github.event.inputs.tag }}',
                                              body: 'promote til ${{ github.event.inputs.cluster }} ${{ env.NAMESPACE }} feilet'})
                      github.rest.issues.addLabels({...issue, labels: ['deployment-failed','${{ github.event.inputs.cluster }}:${{ env.NAMESPACE }}']})

            - name: Oppdater kommentar med deployment status
              if: success()
              uses: actions/github-script@v5
              with:
                  github-token: ${{secrets.GITHUB_TOKEN}}
                  script: |
                      const issue = { owner: context.issue.owner,
                                      repo: context.issue.repo,
                                      issue_number: ${{ github.event.inputs.issue_number }} }
                      github.rest.issues.createComment({...issue,
                                              body: 'promote til  ${{ github.event.inputs.cluster }} ${{ env.NAMESPACE }} utført'})
                      github.rest.issues.addLabels({...issue, labels: ['deployment','${{ github.event.inputs.cluster }}-${{ env.NAMESPACE }}']})
